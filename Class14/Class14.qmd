---
title: "Class 14: RNASeq Mini-Project"
author: "Bernice Lozada (A16297973)"
format: pdf
toc: true
---
Here we run through a complete RNAseq analysis from counts to pathways to biological insight.

## Data Import

```{r}
# Import metadata
colData = read.csv("GSE37704_metadata.csv", row.names=1)

colData

# Import countdata
countData = read.csv("GSE37704_featurecounts.csv", row.names =1)


# remove first $length column
countData <- as.matrix(countData[,-1])
head(countData)
```

```{r}
# filter count data where you have 0 read count across all samples
non_zero <- rowSums(countData) != 0
filtered_countData <- countData[non_zero,]

head(filtered_countData)
```

## Setup for DESeq

```{r}
library(DESeq2)
```


## Running DESeq 

```{r}
dds = DESeqDataSetFromMatrix(countData = filtered_countData,
                             colData = colData,
                             design =~ condition )

dds = DESeq(dds)

res = results(dds, contrast=c("condition", "hoxa1_kd", "control_sirna"))

summary(res)
```


## Add gene annotation data (gene names etc.)

```{r}
library("AnnotationDbi")
library("org.Hs.eg.db")

columns(org.Hs.eg.db)

res$symbol = mapIds(org.Hs.eg.db,
                    keys=row.names(res), 
                    keytype="ENSEMBL",
                    column="SYMBOL",
                    multiVals="first")

res$entrez = mapIds(org.Hs.eg.db,
                    keys=row.names(res),
                    keytype="ENSEMBL",
                    column="ENTREZID",
                    multiVals="first")

res$name =   mapIds(org.Hs.eg.db,
                    keys=row.names(res),
                    keytype="ENSEMBL",
                    column= "GENENAME",
                    multiVals="first")

head(res, 10)
```



## Results visualization

```{r}
plot(res$log2FoldChange,-log(res$padj))
```
Make it colorful :)
```{r}
# Make a color vector for all genes
mycols <- rep("gray", nrow(res) )

# Color red the genes with absolute fold change above 2
mycols[ abs(res$log2FoldChange) > 2 ] <- "red"

# Color blue those with adjusted p-value less than 0.01
#  and absolute fold change more than 2
inds <- (res$padj < 0.01) & (abs(res$log2FoldChange) > 2 )
mycols[ inds ] <- "blue"

plot( res$log2FoldChange, -log(res$padj), col=mycols, xlab="Log2(FoldChange)", ylab="-Log(P-value)" )
```

## Save our results

```{r}
res = res[order(res$pvalue),]
write.csv(res, file ="deseq_results_lab14.csv")
```


## Pathway analysis (KEGG, GO, Reactome)

### Kegg analysis:

```{r}
library(pathview)
library(gage)
library(gageData)

data(kegg.sets.hs)
data(sigmet.idx.hs)

kegg.sets.hs = kegg.sets.hs[sigmet.idx.hs]

head(kegg.sets.hs,3)
```

Make named vector of fold changes
```{r}
foldchanges = res$log2FoldChange
names(foldchanges) = res$entrez
head(foldchanges)
```

Gage pathway analysis:
```{r}
keggres = gage(foldchanges, gsets = kegg.sets.hs)
attributes(keggres)
head(keggres$less)
```

Make a pathway plot:
```{r}
pathview(gene.data = foldchanges, pathway.id = "hsa04110")
```
Focus on top 5 upregulated pathways and make pathway plot:
```{r}
keggrespathways_up <- rownames(keggres$greater)[1:5]

# Extract IDs (8 characters long)
keggresids_up = substr(keggrespathways_up, start = 1, stop = 8)
keggresids_up

pathview(gene.data = foldchanges, pathway.id = keggresids_up, species = "hsa")
```

Making pathway plot for top 5 downregulated pathways:
```{r}
keggrespathways_down <- rownames(keggres$less)[1:5]

# Extract IDs (8 characters long)
keggresids_down = substr(keggrespathways_down, start = 1, stop = 8)
keggresids_down

pathview(gene.data = foldchanges, pathway.id = keggresids_down, species = "hsa")
```
### GO Analysis

```{r}
data(go.sets.hs)
data(go.subs.hs)

# Focusing on Biological Process subset of GO
gobpsets = go.sets.hs[go.subs.hs$BP]

gobpres = gage(foldchanges, gsets = gobpsets, same.dir = TRUE)

lapply(gobpres, head)
```

### Reactome Analysis

Get list of significant genes and output as a plain text file:
```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
head(sig_genes)

# write.table(sig_genes, file = "significant_genes.txt", row.names = FALSE, col.names = FALSE, quote = FALSE)
```
> Q: What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

The cell cycle pathway has the most significant "entities p-value". The most significant pathways in the Reactome analysis have to do with the cell cycle, which is the same for the KEGG pathways. However, the KEGG pathway analysis also implicated glycolysis as a significantly changed pathway, while it was not in the top 20 for Reactome. This is likely because the Reactome has more detailed, overlapping reactions within one pathway, while KEGG just reveals the overall pathway.

### GO Online

> Q: What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

The negative regulation of glycogen biosynthetic process has the most significant entities p-value. Though the order of significant pathways is different between the KEGG and GO analysis, the content is the same. This may be because GO will annotate and organize by specific reactions, while KEGG will annotate general pathways by simply detecting genes that are all implicated in a general pathway.
